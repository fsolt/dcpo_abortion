---
output: 
  pdf_document:
    citation_package: natbib
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
    template: svm-latex-ms2.tex
title: "[Abortion Attitudes Paper Title]"
thanks: "Corresponding author: [frederick-solt@uiowa.edu](mailto:frederick-solt@uiowa.edu).  Current version: `r format(Sys.time(), '%B %d, %Y')`."
author:
- name: Yue Hu
  affiliation: Tsinghua University
- name: Yuehong 'Cassandra' Tai
  affiliation: University of Iowa
- name: Byung-Deuk Woo
  affiliation: University of Iowa
- name: Frederick Solt
  affiliation: University of Iowa
anonymous: false
abstract: " [0/150 words]"
keywords: ""
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
spacing: double
bibliography: \dummy{`r file.path(getwd(), list.files(getwd(), ".bib$", recursive = TRUE))`}
# csl: https://raw.githubusercontent.com/citation-style-language/styles/master/american-political-science-association.csl
biblio-style: apsr
citecolor: black
linkcolor: black
endnote: no
header-includes:
      - \usepackage{array}
      - \usepackage{caption}
      - \usepackage{graphicx}
      - \usepackage{siunitx}
      - \usepackage{colortbl}
      - \usepackage{multirow}
      - \usepackage{hhline}
      - \usepackage{calc}
      - \usepackage{tabularx}
      - \usepackage{threeparttable}
      - \usepackage{wrapfig}
---

```{r setup, include=FALSE}
options(tinytex.verbose = TRUE)

knitr::opts_chunk$set(cache = TRUE, echo = FALSE, message = FALSE, warning = FALSE,
                      fig.width=7, fig.height=2.5)

# If `DCPOtools` is not yet installed:
# remotes::install_github("fsolt/DCPOtools")

library(DCPOtools)
library(DCPO)
library(tidyverse)
library(countrycode)
library(patchwork)
library(rsdmx)

set.seed(324)
```

```{r dcpo_input_raw, include=FALSE}
surveys_ab <- read_csv(here::here("data-raw", "surveys_abortion2.csv"),
                        col_types = "cccccc")

dcpo_input_raw <- DCPOtools::dcpo_setup(vars = surveys_ab,
                                        datapath = here::here("..",
                                                              "data", "dcpo_surveys"),
                                        file = here::here("data",
                                                          "dcpo_input_raw.csv"))
```

```{r ab_summary_stats}
dcpo_input_raw <- read_csv(here::here("data", "dcpo_input_raw.csv"),
                                  col_types = "cdcddcd")

process_dcpo_input_raw <- function(dcpo_input_raw_df) {
  dcpo_input_raw_df %>% 
  with_min_yrs(3) %>% 
  with_min_cy(5) %>% 
  group_by(country) %>% 
  mutate(cc_rank = n()) %>% 
  ungroup() %>% 
  arrange(-cc_rank)
} 

dcpo_input_raw1 <- process_dcpo_input_raw(dcpo_input_raw)

n_surveys <- surveys_ab %>%
  distinct(survey) %>% 
  nrow()

n_items <- dcpo_input_raw1 %>%
  distinct(item) %>% 
  nrow()

n_countries <- dcpo_input_raw1 %>%
  distinct(country) %>% 
  nrow()

n_cy <- dcpo_input_raw1 %>%
  distinct(country, year) %>% 
  nrow() %>% 
  scales::comma()

n_years <- as.integer(summary(dcpo_input_raw1$year)[6]-summary(dcpo_input_raw1$year)[1])

spanned_cy <- dcpo_input_raw1 %>% 
  group_by(country) %>% 
  summarize(years = max(year) - min(year) + 1) %>% 
  summarize(n = sum(years)) %>% 
  pull(n) %>% 
  scales::comma()

total_cy <- {n_countries * n_years} %>% 
  scales::comma()

year_range <- paste("from",
                    summary(dcpo_input_raw1$year)[1],
                    "to",
                    summary(dcpo_input_raw1$year)[6])

n_cyi <- dcpo_input_raw1 %>% 
  distinct(country, year, item) %>% 
  nrow() %>% 
  scales::comma()

back_to_numeric <- function(string_number) {
  string_number %>% 
    str_replace(",", "") %>% 
    as.numeric()
}

covered_share_of_spanned <- {back_to_numeric(n_cy)/back_to_numeric(spanned_cy) * 100}
```




# Examining the Source Data on Abortion Attitudes
<!-- This should be reworded -->

National and cross-national surveys have often included questions about abortion over the past half-century, but the resulting data are both sparse, that is, unavailable for many countries and years, and incomparable, generated by many different survey items.
In all, we identified `r n_items` such survey items that were asked in no fewer than five country-years in countries surveyed at least twice; these items were drawn from `r n_surveys` different survey datasets.^[
The complete list of survey items on abortion is included in the Appendix.]
Together, the survey items in the source data were asked in `r n_countries` different countries in at least two time points over `r n_years` years, `r year_range`, yielding a total of `r n_cyi` country-year-item observations.
Observations for every year in each country surveyed would number `r total_cy`, and a complete set of country-year-items would encompass `r {n_countries * n_years * n_items} %>% scales::comma()` observations.
Viewed from this complete-data perspective, the available data can be seen to be very, very sparse.
From a more optimistic standpoint, we note there there are `r n_cy` country-years in which we have at least _some_ information about the public gender egalitarianism of the population, that is, some `r {back_to_numeric(n_cy)/back_to_numeric(spanned_cy) * 100} %>% round()`% of the `r spanned_cy` country-years spanned by the data we collected.
But there can be no denying that the many different survey items employed renders these data incomparable and difficult to use together.

```{r item_and_country_plots, fig.height = 3.5, fig.cap = "Countries and Years with the Most Observations in the Abortion Attitudes Source Data \\label{item_country_plots}"}
items_plot <- dcpo_input_raw1 %>%
  distinct(country, year, item) %>%
  count(item) %>%
  arrange(desc(n)) %>% 
  head(12) %>% 
  ggplot(aes(forcats::fct_reorder(item, n, .desc = TRUE), n)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x  = element_text(angle = 90, vjust = .45, hjust = .95),
        axis.title.y = element_text(size = 9),
        plot.title = element_text(hjust = 0.5, size = 11)) +
  ylab("Country-Years\nObserved") +
  ggtitle("Items")

just10_cy <- dcpo_input_raw1 %>% filter(item == "just10") %>% distinct(country, year) %>% nrow()

just10_surveys <- dcpo_input_raw1 %>% filter(item == "just10") %>% distinct(survey) %>% pull(survey)

countries_plot <- dcpo_input_raw1 %>%
  mutate(country = if_else(stringr::str_detect(country, "United"),
                           stringr::str_replace(country, "((.).*) ((.).*)", "\\2.\\4."),
                           country)) %>% 
  distinct(country, year, item) %>% 
  count(country) %>%
  arrange(desc(n)) %>% 
  head(12) %>% 
  ggplot(aes(forcats::fct_reorder(country, n, .desc = TRUE), n)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x  = element_text(angle = 90, vjust = .45, hjust = .95),
        axis.title.y = element_text(size = 9),
        plot.title = element_text(hjust = 0.5, size = 11)) +
  ylab("Year-Items\nObserved") +
  ggtitle("Countries")

cby_plot <- dcpo_input_raw1 %>%
  mutate(country = if_else(stringr::str_detect(country, "United"),
                           stringr::str_replace(country, "((.).*) ((.).*)", "\\2.\\4."),
                           country),
         country = stringr::str_replace(country, "South", "S.")) %>% 
  distinct(country, year) %>%
  count(country) %>% 
  arrange(desc(n)) %>% 
  head(12) %>% 
  ggplot(aes(forcats::fct_reorder(country, n, .desc = TRUE), n)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x  = element_text(angle = 90, vjust = .45, hjust = .95),
        axis.title.y = element_text(size = 9),
        plot.title = element_text(hjust = 0.5, size = 11)) +
  ylab("Years\nObserved") +
  ggtitle("Countries")


ybc_plot <- dcpo_input_raw1 %>%
  distinct(country, year) %>%
  count(year, name = "nn") %>%
  ggplot(aes(year, nn)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        # axis.text.x  = element_text(angle = 90, vjust = .45, hjust = .95),
        axis.title.y = element_text(size = 9),
        plot.title = element_text(hjust = 0.5, size = 11)) +
  ylab("Countries\nObserved") +
  ggtitle("Years")

us_obs <- dcpo_input_raw1 %>% 
  distinct(country, year, item) %>%
  count(country) %>%
  filter(country == "United States") %>%
  pull(n)

others <- dcpo_input_raw1 %>%
  distinct(country, year, item) %>%
  count(country) %>%
  arrange(desc(n)) %>%
  slice(2:5) %>%
  pull(country) %>% 
  paste(collapse = ", ") %>% 
  str_replace(", (\\w+)$", ", and \\1")

countries_cp <- dcpo_input_raw1 %>%
  mutate(country = if_else(stringr::str_detect(country, "United"),
                           stringr::str_replace(country, "((.).*) ((.).*)", "\\2.\\4."),
                           country),
         country = stringr::str_replace(country, "South", "S.")) %>% 
  distinct(country, year, item) %>%
  count(country) %>% 
  arrange(desc(n)) %>% 
  head(12) %>% 
  pull(country)

countries_cbyp <- dcpo_input_raw1 %>%
  mutate(country = if_else(stringr::str_detect(country, "United"),
                           stringr::str_replace(country, "((.).*) ((.).*)", "\\2.\\4."),
                           country),
         country = stringr::str_replace(country, "South", "S.")) %>% 
  distinct(country, year) %>%
  count(country) %>% 
  arrange(desc(n)) %>% 
  head(12) %>% 
  pull(country)

adding <- setdiff(countries_cbyp, countries_cp) %>% 
  paste(collapse = ", ") %>% 
  str_replace(", (\\w*)$", ", and \\1")

dropping <- setdiff(countries_cp, countries_cbyp) %>% 
  paste(collapse = ", ") %>% 
  str_replace(", (\\w*)$", ", and \\1")

y_peak_year <- dcpo_input_raw1 %>%
  distinct(country, year) %>%
  count(year, name = "nn") %>% 
  filter(nn == max(nn)) %>% 
  pull(year)

y_peak_nn <- dcpo_input_raw1 %>%
  distinct(country, year) %>%
  count(year, name = "nn") %>% 
  filter(nn == max(nn)) %>% 
  pull(nn)

data_poorest <- dcpo_input_raw1 %>%
  distinct(country, year, item) %>%
  count(country) %>%
  arrange(n) %>%
  filter(n == 2) %>%
  pull(country) %>% 
  paste(collapse = ", ") %>% 
  str_replace(", (\\w+)$", ", and \\1")

wordify_numeral <- function(x) setNames(c("one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen", "sixteen", " seventeen", "eighteen", "nineteen"), 1:19)[x]

n_data_poorest <- {data_poorest %>%
    str_split(",") %>% 
    first()} %>% 
  length() %>% 
  wordify_numeral()

(countries_plot + cby_plot) / (ybc_plot)
```

Consider the most frequently asked item in the data we collected, which asks respondents whether they think abortion "can always be justified, never be justified, or something in between," using a ten-point scale.
Employed by the Asia Barometer, the European Values Survey, the Latinobarómetro, the United Nations Development Programme, and the World Values Survey, this question was asked in a total of `r just10_cy` different country-years.
That this constitutes only `r {just10_cy*100/(spanned_cy %>% str_replace(",", "") %>% as.numeric())} %>% round()`% of the country-years spanned by our data---and remember, this is the _most common_ survey item---again underscores just how sparse and incomparable the available public opinion data is on this topic.

The upper left panel of Figure&nbsp;\ref{item_country_plots} shows the dozen countries with the highest count of country-year-item observations.
The United States, with `r us_obs` observations, is far and away the best represented country in the source data, followed by `r others`.
At the other end of the spectrum, `r n_data_poorest` countries---`r data_poorest`---have only the minimum two observations required to be included in the source dataset at all.
The upper right panel shows the twelve countries with the most years observed; this group is similar, but with `r adding` joining the list and `r dropping` dropping off.
The bottom panel counts the countries observed in each year and reveals just how few relevant survey items were asked before 1990.
Country coverage reached its peak in `r y_peak_year`, when surveys in `r y_peak_nn` countries included items on abortion.
In the next section, we describe how we are able to make use of all of this sparse and incomparable survey data to generate estimates of public opinion that are comparable across countries and years using a latent variable model.

```{r dcpo_input_public, eval=FALSE}
dcpo_input <- DCPOtools::format_dcpo(dcpo_input_raw1,
                                            scale_q = "just10",
                                            scale_cp = 5)
save(dcpo_input, file = here::here("data", "dcpo_input.rda"))
```

## Abortion: Global Status and Attitudes


```{r dcpo, eval=FALSE}
iter <- 5000

dcpo_output <- dcpo(dcpo_input,
                    iter = iter,
                    chains = 4,
                    thin = iter/500, # this yields 250 draws per chain, 1000 draws total
                    pars = c("sd_delta","sd_theta_evolve", "sd_sigma_evolve", "sigma","phi","beta","alpha","delta","theta","y_r_pred","log_lik"))
```

```{r dcpo_results}
load(here::here("data", "just10_5_4k_04-08.rda"))

save(dcpo_input, file = here::here("data", "dcpo_input.rda"))

save(dcpo_output, file = here::here("data", "dcpo_output.rda"))
```

```{r dcpo_results_summary}
load(here::here("data", "dcpo_input.rda"))
load(here::here("data", "dcpo_output.rda"))

theta_results <- DCPO::summarize_dcpo_results(dcpo_input,
                                              dcpo_output,
                                              "theta")

res_cy <- nrow(theta_results) %>% 
  scales::comma()

res_c <- theta_results %>% 
  pull(country) %>% 
  unique() %>% 
  length()
```


```{r cs_plot, fig.cap="Abortion Opinion Scores, Most Recent Available Year \\label{cs_mry}", fig.height=10, fig.width=8}

n_panes <- 2
axis_text_size <- 10

p1_data <- theta_results %>%
  group_by(country) %>%
  top_n(1, year) %>%
  ungroup() %>%
  arrange(mean) %>%
  transmute(country_year = paste0(country, " (", year, ")") %>% 
              str_replace("’", "'"),
            estimate = mean,
            conf.high = `90%`,
            conf.low = `10%`,
            pane = n_panes - (ntile(mean, n_panes) - 1),
            ranked = as.factor(ceiling(row_number())))

p_theta <- ggplot(p1_data,
                  aes(x = estimate, y = ranked)) +
  geom_segment(aes(x = conf.low, xend = conf.high,
                   y = ranked, yend = ranked),
               na.rm = TRUE,
               alpha = .4) +
  geom_point(fill = "black", shape = 21, size = .5, na.rm = TRUE) +
  theme_bw() + theme(legend.position="none",
                     axis.text.x  = element_text(size = axis_text_size,
                                                 angle = 90,
                                                 vjust = .45,
                                                 hjust = .95),
                     axis.text.y  = element_text(size = axis_text_size),
                     axis.title = element_blank(),
                     strip.background = element_blank(), 
                     strip.text = element_blank(),
                     panel.grid.major = element_line(size = .3),
                     panel.grid.minor = element_line(size = .15)) +
  scale_y_discrete(breaks = p1_data$ranked, labels=p1_data$country_year) +
  coord_cartesian(xlim=c(0, 1)) +
  facet_wrap(vars(pane), scales = "free", nrow = 1)


p_theta +
  plot_annotation(caption = "Note: Gray whiskers represent 80% credible intervals.")

```

```{r ts_plots, fig.cap="Abortion Opinion Scores Over Time Within Selected Countries \\label{ts}", fig.height=3.5}
countries <- c("Sweden", "France", "Spain", "Ireland",
               "United States", "Germany", "Chile", "Italy",
               "Russia", "South Korea", "Poland", "Argentina", 
               "Mexico", "South Africa", "Philippines", "China")

countries2 <- c("Sweden", "France", "Spain", "Ireland",
               "U.S.", "Germany", "Chile", "Italy",
               "Russia", "South Korea", "Poland", "Argentina", 
               "Mexico", "South Africa", "Philippines", "China")

theta_results %>%
  filter(country %in% countries) %>%
  mutate(country = str_replace(country, "United States", "U.S.") %>% 
           factor(levels = countries2)) %>% 
  ggplot(aes(x = year, y = mean)) +
  geom_ribbon(aes(ymin = `10%`, ymax = `90%`, linetype=NA), alpha = .25) +
  geom_line() +
  theme_bw() +
  theme(legend.position="none") +
  coord_cartesian(xlim = c(1980, 2020), ylim = c(0, 1)) +
  labs(x = NULL, y = "Abortion Opinion Scores") +
  facet_wrap(~country, nrow = 2) +
  theme(axis.text.x  = element_text(size=7,
                                    angle = 90,
                                    vjust = .45,
                                    hjust = .95),
        strip.background = element_rect(fill = "white", colour = "white")) +
  plot_annotation(caption = "Note: Countries are ordered by their abortion opinion scores in their most recent\navailable year; gray shading represents 80% credible intervals.")
```


[Literature review]
The issue of the reproductive rights of women has generated increasing global attention in recent years.
In September 2016, independent human rights experts from UN urged countries to remove laws and policies related to abortion (Special Procedures of the Human Rights Council, 2016) and, in 2018, UN Human Rights committee asserts that access to abortion should be regarded as one of human rights.
With the increased saliency of abortion issue, a wide array of scholars has examined the public opinion toward abortion (see, e.g., Combs and Welch 1982; Barreiro 1998; Arceneaux 2002; Blofield 2006; Brickman and Peterson; Cook 2019).
Especially, unveiling the factors determining the public opinion toward abortion has been one of the main topics in the literature of abortion (see, e.g., Jelen and Wilcox 2003; Wang and Buffalo 2004; Adamczyk 2013; Loll and Hall 2019; Adamczyk, Kim, and Dillon 2020).
Rather than reaching a consensus, scholars have focused on different sets of explanatory variables affecting attitude toward abortion.
Some scholars argue that individual characteristics such as religiosity are the main factors determining the attitude toward abortion (see, e.g., Welch et al. 1995; Evans 2002; Ellison, Echevarria, and Smit 2005; Adamczyk 2018), while others emphasize the role of socio-demographic factors on abortion attitude (see, e.g., Adebayo 1990; Bose and Trent 2006; Rossier 2007).

[I can add summary of previous findings according to regions: for example, US and Outside of US.
[Maybe we can introduce our explanatory variables here with previous literature, the length and focus of literature review can depend on our set of control variables / I can add summary of previous findings according to the focused explanatory variables].

However, the absence of comparable index measuring public attitude towards abortion prevents us from testing which kinds of variables examine the variations among public attitude toward abortion at the aggregated-level and from the generalizability of the previous findings.
In this article, we introduce the dataset about public attitude towards abortion.
[Simple Explanation about our brand-new dataset].
[Explanation about results]
This article proceeds with the following orders.
[Explanation about our paper organization].



## What Alters Abortion Attitudes: Alternative Explanations

1. Institutionalization: abortion attitudes is led by the legalization of abortion.

Controls

1. Culturalism: abortion attitudes is changed with the advance of socioeconomic and post-materialism development (gender egalitarianism)
1. Ideology: abortion attitudes is driven by dominated political ideology, conservative, liberal, socialism, etc. 
1. Inequality: riches always have ways to abort if they want, but they are also benefited by cheap labors mainly from poor kids. (Ref. religion-inequality)


## Empirical Research

### Data and Methods

Explanatory and outcome variables

+ DCPO abortion data 
+ Abortion laws around the world

Controls

+ Post-materialist stages (MrsP?)
+ Ideological trend (any data?)
+ Inequality (SWIID)

## Research Design

1. Great data
1. Congruence of public opinion and policy
1. Individual time-series: adoption makes a different to opinion (RD)
    + abortion attitude (lag) -> legalization: abortion legalized by judicial ruling -> as if random

### Results

## Summary and Discussion


\pagebreak
